<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Contract Transaction Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .log { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; margin: 10px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .info { background: #e7f3ff; border: 1px solid #b3d9ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #ffebee; border: 1px solid #ffcdd2; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Smart Contract Transaction Debug</h1>
        
        <div class="info">
            <h3>Contract Information:</h3>
            <strong>Package ID:</strong> 0x2a0eeb98d575a07fe472e02e3872fd5fabc960e0350c19e084aaff7535235fa6<br>
            <strong>Processor Object:</strong> 0xd1a10185b58c7501bd23aedb5e7d1942bca97e0b882ee52fd930cad1169d6feee<br>
            <strong>Function:</strong> payment_processor::process_widget_payment
        </div>

        <div style="margin: 20px 0;">
            <label>Merchant Address:</label>
            <input type="text" id="merchantAddr" placeholder="0x..." style="width: 400px; padding: 5px;" value="0x9b7d1f591f5fc7395935d2ebb7063ca9f710aa26844f1d50d4ffea9f65e17fbb">
            <button onclick="testTransaction()">üß™ Test Transaction Build</button>
            <button onclick="testWalletMethods()">üîç Test Wallet Methods</button>
            <button onclick="installWalletGuide()" style="background: #28a745;">üì± Wallet Install Guide</button>
        </div>

        <div class="log" id="debugLog">üöÄ Smart Contract Transaction Debugger Ready!
üìã This tool will help debug transaction building and execution issues.
</div>
    </div>

    <script>
        const log = (msg) => {
            const logEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `\n[${timestamp}] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${timestamp}] ${msg}`);
        };

        async function testWalletMethods() {
            log('üîç Testing wallet detection and methods...');
            
            // Check for wallets
            const wallets = [];
            if (window.suiet) wallets.push('Suiet');
            if (window.suiWallet) wallets.push('Sui Wallet');
            if (window.ethos) wallets.push('Ethos');
            
            log(`üì± Detected wallets: ${wallets.join(', ') || 'None'}`);
            
            if (wallets.length === 0) {
                log('‚ùå No wallets detected. Please install a Sui wallet.');
                return;
            }
            
            // Test wallet object
            const wallet = window.suiet || window.suiWallet || window.ethos;
            log('üîß Wallet object methods:');
            
            const methods = Object.getOwnPropertyNames(wallet).filter(name => typeof wallet[name] === 'function');
            methods.forEach(method => log(`  - ${method}()`));
            
            // Test connection
            try {
                log('üîó Testing wallet connection...');
                let connected = false;
                
                if (wallet.requestPermissions) {
                    await wallet.requestPermissions(['viewAccount', 'suggestTransactions']);
                    connected = true;
                } else if (wallet.connect) {
                    await wallet.connect();
                    connected = true;
                }
                
                if (connected) {
                    log('‚úÖ Wallet connected successfully');
                    
                    // Get accounts
                    const accounts = await wallet.getAccounts();
                    log(`üë§ Accounts found: ${accounts?.length || 0}`);
                    if (accounts && accounts.length > 0) {
                        log(`üìç First account: ${accounts[0].address}`);
                    }
                } else {
                    log('‚ùå Wallet connection failed');
                }
                
            } catch (error) {
                log(`‚ùå Wallet connection error: ${error.message}`);
            }
        }

        async function testTransaction() {
            const merchantAddr = document.getElementById('merchantAddr').value;
            if (!merchantAddr) {
                log('‚ùå Please enter a merchant address');
                return;
            }
            
            log('üß™ Testing transaction building...');
            
            // Contract details
            const contractPackage = '0x2a0eeb98d575a07fe472e02e3872fd5fabc960e0350c19e084aaff7535235fa6';
            const processorObject = '0xd1a10185b58c7501bd23aedb5e7d1942bca97e0b882ee52fd930cad1169d6feee';
            const amount = 0.1;
            const amountMist = Math.floor(amount * 1_000_000_000);
            
            log(`üìä Transaction parameters:`);
            log(`  - Package: ${contractPackage}`);
            log(`  - Processor: ${processorObject}`);
            log(`  - Merchant: ${merchantAddr}`);
            log(`  - Amount: ${amount} SUI (${amountMist} MIST)`);
            
            // Test different transaction formats
            log('üîß Testing transaction formats...');
            
            // ‚ö†Ô∏è CRITICAL FIX: The smart contract expects Coin<SUI>, not amount!
            // We need to let the wallet handle coin creation
            
            // Format 1: Simple call format (CORRECTED - no amount argument)
            const format1 = {
                target: `${contractPackage}::payment_processor::process_widget_payment`,
                arguments: [
                    processorObject,
                    merchantAddr,
                    Array.from(new TextEncoder().encode('test-merchant')),
                    Array.from(new TextEncoder().encode('test-product'))
                    // NOTE: Removed amount - wallet will handle coin creation
                ],
                typeArguments: [],
                value: amountMist // This tells wallet how much to send
            };
            log(`üìù Format 1 (Simple - FIXED): ${JSON.stringify(format1, null, 2)}`);
            
            // Format 2: Move call format (CORRECTED)
            const format2 = {
                packageObjectId: contractPackage,
                module: 'payment_processor',
                function: 'process_widget_payment',
                arguments: [
                    processorObject,
                    merchantAddr,
                    Array.from(new TextEncoder().encode('test-merchant')),
                    Array.from(new TextEncoder().encode('test-product'))
                    // NOTE: Removed amount - wallet handles coin creation
                ],
                typeArguments: [],
                gasBudget: 30000000,
                // Tell wallet to create a coin with this amount
                coinType: '0x2::sui::SUI',
                amount: amountMist
            };
            log(`üìù Format 2 (MoveCall - FIXED): ${JSON.stringify(format2, null, 2)}`);
            
            // Format 3: Transaction block format (ADVANCED - with coin splitting)
            const format3 = {
                kind: 'ProgrammableTransaction',
                inputs: [
                    { type: 'object', objectType: 'sharedObject', objectId: processorObject },
                    { type: 'pure', valueType: 'address', value: merchantAddr },
                    { type: 'pure', valueType: 'vector<u8>', value: Array.from(new TextEncoder().encode('test-merchant')) },
                    { type: 'pure', valueType: 'vector<u8>', value: Array.from(new TextEncoder().encode('test-product')) },
                    { type: 'pure', valueType: 'u64', value: amountMist }
                ],
                transactions: [
                    // Step 1: Split coin from gas
                    {
                        SplitCoins: {
                            coins: { GasCoin: null },
                            amounts: [{ Input: 4 }]  // Split the payment amount
                        }
                    },
                    // Step 2: Call smart contract with the split coin
                    {
                        MoveCall: {
                            package: contractPackage,
                            module: 'payment_processor',
                            function: 'process_widget_payment',
                            arguments: [
                                { Input: 0 }, // processor
                                { Input: 1 }, // merchant_address
                                { Input: 2 }, // merchant_id
                                { Input: 3 }, // product_id
                                { Result: 0 } // Use the split coin from step 1
                            ]
                        }
                    }
                ]
            };
            log(`üìù Format 3 (ProgrammableTransaction - FIXED): ${JSON.stringify(format3, null, 2)}`);
            
            log('‚úÖ FIXED transaction formats generated. The key fix: removed amount argument, wallet handles coin creation.');
            log('üîç Key insight: Smart contract expects Coin<SUI> object, not amount number!');
            
            // Test with actual wallet if available
            const wallet = window.suiet || window.suiWallet;
            if (wallet) {
                log('üîó Testing with wallet...');
                
                try {
                    // Try to connect first
                    if (wallet.requestPermissions) {
                        await wallet.requestPermissions(['viewAccount', 'suggestTransactions']);
                    }
                    
                    // Try format 2 (most common)
                    log('üß™ Attempting transaction with Format 2...');
                    
                    const result = await wallet.signAndExecuteTransaction(format2);
                    log(`‚úÖ Transaction successful: ${result.digest}`);
                    
                } catch (error) {
                    log(`‚ùå Transaction failed: ${error.message}`);
                    log(`üîç Error details: ${JSON.stringify(error, null, 2)}`);
                }
            } else {
                log('‚ö†Ô∏è No wallet available for testing');
            }
        }

        function installWalletGuide() {
            log('üì± Wallet Installation Guide:');
            log('');
            log('üî• RECOMMENDED: Suiet Wallet');
            log('   1. Visit: https://suiet.app/');
            log('   2. Click "Install Extension" for Chrome/Edge');
            log('   3. Create/Import wallet');
            log('   4. Switch to "Testnet" in settings');
            log('   5. Get test SUI from https://faucet.sui.io/');
            log('');
            log('üî• ALTERNATIVE: Sui Wallet');
            log('   1. Visit Chrome Web Store');
            log('   2. Search "Sui Wallet"');
            log('   3. Install and setup');
            log('   4. Switch to testnet');
            log('');
            log('üîÑ After installation:');
            log('   1. Refresh this page');
            log('   2. Click "üîç Test Wallet Methods"');
            log('   3. If detected, test the transaction!');
            log('');
            log('üí° TIPS:');
            log('   - Make sure wallet extension is enabled');
            log('   - Try opening wallet popup first');
            log('   - Some wallets need page refresh after install');
        }
    </script>
</body>
</html>
