<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ SuiFlow LIVE Smart Contract Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .success-banner {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .contract-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #10B981;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }
        button {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
            font-weight: bold;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-banner">
            <h1>üéâ SuiFlow Smart Contract DEPLOYED!</h1>
            <p>Your payment processor is live on Sui testnet blockchain</p>
        </div>

        <!-- Contract Information -->
        <div class="contract-info">
            <h3>üìã Live Contract Details</h3>
            <strong>Package ID:</strong> 0x2a0eeb98d575a07fe472e02e3872fd5fabc960e0350c19e084aaff7535235fa6<br>
            <strong>Processor Object:</strong> 0xd1a10185b58c7501bd23aedb5e7d1942bca97e0b882ee52fd930cad1169d6feee<br>
            <strong>Admin Address:</strong> 0x6b3bd536eb26182cfb83b921d2a2216e3275583298beeb1d736fc94dc29669cd<br>
            <strong>Network:</strong> Sui Testnet<br>
            <strong>Admin Fee:</strong> 0.01 SUI per transaction
        </div>

        <!-- Test Payment -->
        <div class="section">
            <h3>üí∞ Test Live Smart Contract Payment</h3>
            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> You need a Sui wallet (Suiet, Sui Wallet, or Ethos) with testnet SUI to test smart contract payments.
            </div>
            
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label>Merchant ID:</label>
                        <input type="text" id="merchantId" value="68764e309fcf5da6c3f17f6d">
                    </div>
                    <div class="form-group">
                        <label>Amount (SUI):</label>
                        <input type="number" id="amount" value="0.1" step="0.01" min="0.02">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Merchant Wallet Address:</label>
                        <input type="text" id="merchantAddress" placeholder="0x...merchant wallet address">
                    </div>
                    <div class="form-group">
                        <label>Product ID:</label>
                        <input type="text" id="productId" value="test-widget">
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button onclick="testWalletConnection()" id="walletTestButton" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">
                    üîç Test Wallet Connection
                </button>
                <button onclick="testSmartContract()" id="contractButton">
                    ‚ö° Test Smart Contract Payment
                </button>
                <button onclick="testHybrid()" id="hybridButton">
                    üîÑ Test Hybrid Payment (Smart Contract + Popup)
                </button>
                <button onclick="testPopup()" id="popupButton">
                    ü™ü Test Popup Only
                </button>
            </div>
        </div>

        <!-- Wallet Setup -->
        <div class="section">
            <h3>üí≥ Wallet Setup Instructions</h3>
            <ol>
                <li><strong>Install Sui Wallet:</strong>
                    <ul>
                        <li><a href="https://suiet.app/" target="_blank">Suiet Wallet</a> (Recommended)</li>
                        <li><a href="https://chrome.google.com/webstore/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil" target="_blank">Sui Wallet</a></li>
                        <li><a href="https://ethoswallet.xyz/" target="_blank">Ethos Wallet</a></li>
                    </ul>
                </li>
                <li><strong>Switch to Testnet:</strong> In wallet settings, select "Testnet"</li>
                <li><strong>Get Test SUI:</strong> Visit <a href="https://faucet.sui.io/" target="_blank">Sui Faucet</a></li>
                <li><strong>Connect Wallet:</strong> Click test button above and approve connection</li>
            </ol>
        </div>

        <!-- Transaction Log -->
        <div class="section">
            <h3>üìä Live Transaction Log</h3>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
            <div class="log" id="transactionLog">
üöÄ SuiFlow Smart Contract Test Ready!
üìã Contract: 0x2a0eeb98d575a07fe472e02e3872fd5fabc960e0350c19e084aaff7535235fa6
üè™ Processor: 0xd1a10185b58c7501bd23aedb5e7d1942bca97e0b882ee52fd930cad1169d6feee
üí° Try making a payment to see your smart contract in action!
            </div>
        </div>
    </div>

    <!-- Load Enhanced SDK with Live Contract -->
    <script src="./suiflow.js"></script>
    
    <script>
        let logContainer = document.getElementById('transactionLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logContainer.innerHTML += '\n' + logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(logEntry);
        }

        function clearLog() {
            logContainer.innerHTML = 'üöÄ SuiFlow Smart Contract Test Ready!\nüìã Transaction log cleared';
        }

        async function testWalletConnection() {
            const button = document.getElementById('walletTestButton');
            button.disabled = true;
            button.textContent = '‚è≥ Testing...';

            try {
                log('üîç Manual wallet connection test starting...');
                
                // Check all possible wallet objects
                const walletChecks = [
                    { name: 'Suiet', obj: window.suiet },
                    { name: 'Sui Wallet', obj: window.suiWallet },
                    { name: 'Ethos', obj: window.ethos },
                    { name: 'Generic Sui', obj: window.sui }
                ];
                
                let foundWallet = null;
                
                for (const check of walletChecks) {
                    if (check.obj) {
                        log(`‚úÖ Found ${check.name} wallet object`);
                        log(`üîç ${check.name} methods: ${Object.keys(check.obj).join(', ')}`);
                        
                        // Try to connect to this wallet
                        try {
                            if (check.obj.requestPermissions) {
                                log(`üîó Trying to connect to ${check.name}...`);
                                const result = await check.obj.requestPermissions(['viewAccount', 'suggestTransactions']);
                                log(`‚úÖ ${check.name} connection result:`, JSON.stringify(result));
                                foundWallet = check;
                                break;
                            } else if (check.obj.connect) {
                                log(`üîó Trying to connect to ${check.name} (connect method)...`);
                                const result = await check.obj.connect();
                                log(`‚úÖ ${check.name} connection result:`, JSON.stringify(result));
                                foundWallet = check;
                                break;
                            } else {
                                log(`‚ö†Ô∏è ${check.name} found but no connect method`);
                            }
                        } catch (connectError) {
                            log(`‚ùå ${check.name} connection failed: ${connectError.message}`);
                        }
                    } else {
                        log(`‚ùå ${check.name} not found`);
                    }
                }
                
                if (foundWallet) {
                    // Try to get accounts
                    try {
                        let accounts;
                        if (foundWallet.obj.getAccounts) {
                            accounts = await foundWallet.obj.getAccounts();
                        } else if (foundWallet.obj.accounts) {
                            accounts = foundWallet.obj.accounts;
                        }
                        
                        if (accounts && accounts.length > 0) {
                            log(`‚úÖ Found ${accounts.length} account(s) in ${foundWallet.name}`);
                            log(`üìù First account: ${accounts[0].address || accounts[0]}`);
                            alert(`‚úÖ Wallet Connection Successful!\n\nWallet: ${foundWallet.name}\nAccounts: ${accounts.length}\nFirst Account: ${accounts[0].address || accounts[0]}`);
                        } else {
                            log(`‚ö†Ô∏è ${foundWallet.name} connected but no accounts found`);
                            alert(`‚ö†Ô∏è Wallet connected but no accounts found.\nPlease create an account in your ${foundWallet.name} wallet.`);
                        }
                    } catch (accountError) {
                        log(`‚ùå Failed to get accounts from ${foundWallet.name}: ${accountError.message}`);
                    }
                } else {
                    log('‚ùå No wallets could be connected');
                    alert('‚ùå No Sui wallets found or none could connect.\n\nPlease:\n1. Install Suiet wallet from suiet.app\n2. Make sure it\'s enabled\n3. Create/import a wallet\n4. Refresh this page');
                }

            } catch (error) {
                log(`‚ùå Wallet test error: ${error.message}`);
                alert(`Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üîç Test Wallet Connection';
            }
        }

        async function testSmartContract() {
            const button = document.getElementById('contractButton');
            button.disabled = true;
            button.textContent = '‚è≥ Processing...';

            try {
                const merchantId = document.getElementById('merchantId').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const merchantAddress = document.getElementById('merchantAddress').value;
                const productId = document.getElementById('productId').value;

                if (!merchantId || !amount || !merchantAddress) {
                    throw new Error('Please fill in all required fields');
                }

                log('üöÄ Testing LIVE smart contract payment...');
                log(`üí∞ Amount: ${amount} SUI | Fee: 0.01 SUI | Merchant gets: ${amount - 0.01} SUI`);

                await window.Suiflow.payWithContract({
                    merchantId,
                    merchantAddress,
                    amount,
                    productId,
                    onSuccess: (txHash, paidAmount, details) => {
                        log(`‚úÖ SMART CONTRACT PAYMENT SUCCESSFUL!`);
                        log(`üì¶ TX Hash: ${txHash}`);
                        log(`üí∞ Total Paid: ${paidAmount} SUI`);
                        log(`üè™ Merchant Received: ${details.merchantReceived} SUI`);
                        log(`üí≥ Admin Fee: ${details.fee} SUI`);
                        log(`üéØ Method: ${details.method}`);
                        
                        // Check transaction on explorer
                        const explorerUrl = `https://testnet.suivision.xyz/txblock/${txHash}`;
                        log(`üîç View on Explorer: ${explorerUrl}`);
                        
                        alert(`üéâ Smart Contract Payment Successful!\n\nüí∞ Amount: ${paidAmount} SUI\nüè™ Merchant got: ${details.merchantReceived} SUI\nüí≥ Your fee: ${details.fee} SUI\n\nüîç View on blockchain explorer:\n${explorerUrl}`);
                    },
                    onError: (error) => {
                        log(`‚ùå Smart contract payment failed: ${error}`);
                        alert(`Payment failed: ${error}`);
                    },
                    onProgress: (message) => {
                        log(`üìç ${message}`);
                    }
                });

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                alert(`Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = '‚ö° Test Smart Contract Payment';
            }
        }

        async function testHybrid() {
            const button = document.getElementById('hybridButton');
            button.disabled = true;
            button.textContent = '‚è≥ Processing...';

            try {
                const merchantId = document.getElementById('merchantId').value;
                const amount = parseFloat(document.getElementById('amount').value);

                log('üîÑ Testing hybrid payment (smart contract + popup fallback)...');

                await window.Suiflow.payWithWidget({
                    merchantId,
                    amount,
                    onSuccess: (txHash, paidAmount, details) => {
                        log(`‚úÖ HYBRID PAYMENT SUCCESSFUL!`);
                        log(`üì¶ TX Hash: ${txHash}`);
                        log(`üí∞ Amount: ${paidAmount} SUI`);
                        log(`üéØ Method Used: ${details.method}`);
                        
                        if (details.method === 'smart_contract') {
                            log(`üè™ Merchant Received: ${details.merchantReceived} SUI`);
                            log(`üí≥ Admin Fee: ${details.fee} SUI`);
                        }
                        
                        alert(`‚úÖ Payment Successful!\nMethod: ${details.method}\nAmount: ${paidAmount} SUI`);
                    },
                    onError: (error) => {
                        log(`‚ùå Hybrid payment failed: ${error}`);
                        alert(`Payment failed: ${error}`);
                    },
                    onProgress: (message) => {
                        log(`üìç ${message}`);
                    }
                });

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                alert(`Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ Test Hybrid Payment';
            }
        }

        function testPopup() {
            const button = document.getElementById('popupButton');
            button.disabled = true;
            button.textContent = '‚è≥ Processing...';

            try {
                const merchantId = document.getElementById('merchantId').value;
                const amount = parseFloat(document.getElementById('amount').value);

                log('ü™ü Testing popup payment (traditional web payment)...');

                window.Suiflow.payWithPopup({
                    merchantId,
                    amount,
                    onSuccess: (txHash, paidAmount, details) => {
                        log(`‚úÖ POPUP PAYMENT SUCCESSFUL!`);
                        log(`üì¶ TX Hash: ${txHash}`);
                        log(`üí∞ Amount: ${paidAmount} SUI`);
                        log(`üéØ Method: ${details.method}`);
                        
                        alert(`‚úÖ Popup Payment Successful!\nAmount: ${paidAmount} SUI`);
                    },
                    onError: (error) => {
                        log(`‚ùå Popup payment failed: ${error}`);
                        alert(`Payment failed: ${error}`);
                    }
                });

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                alert(`Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'ü™ü Test Popup Only';
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Check if SDK loaded
            if (!window.Suiflow) {
                log('‚ùå ERROR: Suiflow SDK not loaded!');
                alert('SDK Loading Error: Please refresh the page');
                return;
            }
            
            log('‚úÖ Suiflow SDK loaded successfully');
            log('üîç SDK Version: ' + (window.Suiflow.version || 'Unknown'));
            
            // Check for Sui wallet libraries
            log('üîç Checking for Sui wallets...');
            const wallets = [];
            
            // More comprehensive wallet detection
            if (typeof window.suiet !== 'undefined') {
                wallets.push('Suiet');
                log('üîç Suiet detected: ' + typeof window.suiet);
            }
            if (typeof window.suiWallet !== 'undefined') {
                wallets.push('Sui Wallet');
                log('üîç Sui Wallet detected: ' + typeof window.suiWallet);
            }
            if (typeof window.ethos !== 'undefined') {
                wallets.push('Ethos');
                log('üîç Ethos detected: ' + typeof window.ethos);
            }
            if (typeof window.sui !== 'undefined') {
                wallets.push('Generic Sui');
                log('üîç Generic Sui detected: ' + typeof window.sui);
            }
            
            // Check for Martian (Aptos-based but might work)
            if (typeof window.martian !== 'undefined') {
                wallets.push('Martian');
                log('üîç Martian detected: ' + typeof window.martian);
            }
            
            // Check all window properties for wallet-like objects
            const windowKeys = Object.keys(window);
            const potentialWallets = windowKeys.filter(key => 
                key.toLowerCase().includes('sui') || 
                key.toLowerCase().includes('wallet') ||
                key.toLowerCase().includes('suiet')
            );
            
            if (potentialWallets.length > 0) {
                log('üîç Potential wallet objects found: ' + potentialWallets.join(', '));
            }
            
            if (wallets.length > 0) {
                log('‚úÖ Found wallets: ' + wallets.join(', '));
            } else {
                log('‚ö†Ô∏è No Sui wallets detected in browser');
                log('üîß Trying to detect wallet after page load...');
                
                // Try again after a delay to let wallet extensions load
                setTimeout(() => {
                    if (window.suiet || window.suiWallet || window.ethos || window.sui) {
                        log('‚úÖ Wallet detected after delay!');
                        if (window.suiet) log('  - Suiet: Available');
                        if (window.suiWallet) log('  - Sui Wallet: Available');
                        if (window.ethos) log('  - Ethos: Available');
                        if (window.sui) log('  - Generic Sui: Available');
                    } else {
                        log('‚ùå Still no wallets detected. Please check:');
                        log('  1. Wallet extension is installed');
                        log('  2. Wallet extension is enabled');
                        log('  3. Try refreshing the page');
                        log('  4. Check browser console for errors');
                    }
                }, 2000);
            }
            
            // Configure SDK for local testing
            window.Suiflow.configure({
                baseUrl: 'http://localhost:4000',
                environment: 'development'
            });
            
            log('üöÄ Page loaded with LIVE smart contract configuration');
            log('üîß SDK configured for local backend: ' + window.Suiflow.getBaseUrl());
            log('üìã Smart contract enabled: ' + window.Suiflow.isSmartContractEnabled());
            log('üéØ Available methods: ' + window.Suiflow.getPaymentMethods().join(', '));
            log('‚úÖ Ready for testing!');
        });
    </script>
</body>
</html>
